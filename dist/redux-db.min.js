<<<<<<< HEAD
var __assign=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();define("utils",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(e){return e?Array.isArray(e)?e:"object"==typeof e?Object.keys(e).map(function(t){return e[t]}):[]:[]},t.ensureArray=function(e){return e?Array.isArray(e)?e:[e]:[]},t.toObject=function(e,t){return e.reduce(function(e,n){return e[t(n)]=n,e},{})},t.arrayMerge=function(e,t){var n,r={};for(n=0;n<e.length;n++)r[e[n]]=!0;for(n=0;n<t.length;n++)r[t[n]]=!0;return Object.keys(r)},t.isEqual=function(e,t){if(e===t)return!0;var r=Object.keys(e),i=Object.keys(t),o=r.length;if(i.length!==o)return!1;for(var a=0;a<o;a++){var s=r[a];if(!(Array.isArray(e[s])&&Array.isArray(t[s])&&n(e[s],t[s]))&&e[s]!==t[s])return!1}return!0};var n=function(e,t){if(e===t)return!0;var n=e.length;if(t.length!==n)return!1;for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}}),define("schema",["require","exports","utils"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="PK",i="FK",o=function(){function e(e){this.output={},this.emits={},this.schema=e,this.db=e.db}return e.prototype.emit=function(e,t){this.emits[e]=this.emits[e]||[],this.emits[e].push(t)},e}();t.NormalizeContext=o;var a=function(){function e(e,t,n){var o=this;this.relations=[],this.db=e,this.name=t,this.fields=Object.keys(n).map(function(e){return new s(o,e,n[e])}),this._primaryKeyFields=this.fields.filter(function(e){return e.type===r}),this._foreignKeyFields=this.fields.filter(function(e){return e.type===i}),this._stampFields=this.fields.filter(function(e){return"MODIFIED"===e.type})}return e.prototype.connect=function(e){var t=this;e.forEach(function(e){t.relations=t.relations.concat(e.fields.filter(function(e){return e.references===t.name}))}),this._foreignKeyFields.forEach(function(t){t.references&&(t.refTable=e.filter(function(e){return e.name===t.references})[0])})},e.prototype.normalize=function(e,t){var r=this;if("object"!=typeof e&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");var i=t||new o(this);return i.output[this.name]||(i.output[this.name]={ids:[],byId:{},indexes:{}}),n.ensureArray(e).map(function(e){var t=r.db.normalizeHooks?r.db.normalizeHooks[r.name]:null;t&&(e=t(e,i));var n=r.getPrimaryKey(e),o=r.getForeignKeys(e),a=i.output[r.name],s=a.byId[n]=__assign({},e);a.ids.push(n),o.forEach(function(e){if("object"==typeof e.value&&e.refTable){var t=e.refTable.normalize(e.value,i);if(t.length>1)throw new Error('Invalid schema definition. The field "'+r.name+"."+e.name+'" is referencing table "'+e.refTable.name+'", but the given data is an array.');s[e.name]=t[0]}null!==e.value&&void 0!==e.value&&(a.indexes[e.name]||(a.indexes[e.name]={}),a.indexes[e.name][e.value]||(a.indexes[e.name][e.value]=[]),a.indexes[e.name][e.value].push(n))});return r.relations.forEach(function(e){if(e.relationName&&s[e.relationName]){var t=r.inferRelations(s[e.relationName],e,n);e.table.normalize(t,i),delete s[e.relationName]}}),n})},e.prototype.inferRelations=function(e,t,r){if(!t.relationName)return e;var o=t.table.fields.filter(function(e){return e.type===i&&e!==t});return n.ensureArray(e).map(function(e){return"number"!=typeof e&&"string"!=typeof e||(1===o.length?((n={})[o[0].name]=e,e=n):e={id:e}),__assign({},e,(i={},i[t.name]=r,i));var n,i})},e.prototype.getPrimaryKey=function(e){var t=(this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields).reduce(function(t,n){var r=n.getValue(e);return t&&r?t+"_"+r:r},null);if(null!==t&&void 0!==t&&"string"!=typeof t&&(t=t.toString()),!t||0===t.length)throw new Error('Failed to get primary key for record of type "'+this.name+'".');return t},e.prototype.getForeignKeys=function(e){return this._foreignKeyFields.map(function(t){return{name:t.name,value:e[t.name],refTable:t.refTable}})},e.prototype.isModified=function(e,t){return this._stampFields.length>0?this._stampFields.reduce(function(n,r){return n+(r.getValue(e)===r.getValue(t)?1:0)},0)!==this._stampFields.length:!n.isEqual(e,t)},e}();t.TableSchema=a;var s=function(){function e(e,t,n){this.table=e,this.name=t,this.propName=n.propName||t,this.type=n.type||n.constraint||(n.references?"FK":"ATTR"),this.references=n.references,this.relationName=n.relationName,this._valueFn=n.value?n.value.bind(this):null}return e.prototype.getValue=function(e,t){return this._valueFn?this._valueFn(e,{schema:this,record:t}):e[this.name]},e.prototype.getRecordValue=function(e){return this.getValue(e.value,e)},e}();t.FieldSchema=s}),define("models",["require","exports","schema","utils"],function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n){void 0===t&&(t={ids:[],byId:{},indexes:{}}),this.session=e,this.state=t,this.schema=n,this.state.name||(this.state.name=n.name)}return e.prototype.all=function(){var e=this;return this.state.ids.map(function(t){return u.default.newRecord(t,e)})},Object.defineProperty(e.prototype,"length",{get:function(){return this.state.ids.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"values",{get:function(){return this.all().map(function(e){return e.value})},enumerable:!0,configurable:!0}),e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.index=function(e,t){return this.state.indexes[e]&&this.state.indexes[e][t]?this.state.indexes[e][t]:[]},e.prototype.get=function(e){if("number"==typeof e&&(e=e.toString()),!this.exists(e))throw new Error('No "'+this.schema.name+'" record with id: '+e+" exists.");return u.default.newRecord(e,this)},e.prototype.value=function(e){return"number"==typeof e&&(e=e.toString()),this.state.byId[e]},e.prototype.getOrDefault=function(e){return this.exists(e)?this.get(e):null},e.prototype.exists=function(e){return"number"==typeof e&&(e=e.toString()),void 0!==this.state.byId[e]},e.prototype.insert=function(e){return this.insertMany(e)[0]},e.prototype.insertMany=function(e){return this._normalizedAction(e,this.insertNormalized)},e.prototype.update=function(e){return this.updateMany(e)[0]},e.prototype.updateMany=function(e){return this._normalizedAction(e,this.updateNormalized)},e.prototype.upsert=function(e){return this._normalizedAction(e,this.upsertNormalized)[0]},e.prototype.delete=function(e){"number"==typeof e&&(e=e.toString());var t=__assign({},this.state.byId),n=this.state.ids.slice(),r=__assign({},this.state.indexes),i=t[e],o=e;delete t[e];var a=n.indexOf(e);a>=0&&n.splice(a,1),i&&this.schema.getForeignKeys(i).forEach(function(t){var n=t.value&&r[t.name][t.value].indexOf(o);if(n>=0){var i=r[t.name][t.value].slice();i.splice(n,1),r[t.name][t.value]=i}else r[t.name]&&(delete r[t.name][e],0===Object.keys(r[t.name]).length&&delete r[t.name])}),this.state=__assign({},this.state,{byId:t,ids:n,indexes:r})},e.prototype.insertNormalized=function(e){var t=this;return this.state=__assign({},this.state,{ids:r.arrayMerge(this.state.ids,e.ids),byId:__assign({},this.state.byId,e.byId)}),this._updateIndexes(e),e.ids.map(function(e){return u.default.newRecord(e,t)})},e.prototype.updateNormalized=function(e){var t=this,n=__assign({},this.state),r=!1,i=Object.keys(e.byId).map(function(i){if(!t.state.byId[i])throw new Error('Failed to apply update. No "'+t.schema.name+'" record with id: '+i+" exists.");var o=e.byId[i],a=n.byId[i];return t.schema.isModified(a,o)&&(n.byId[i]=__assign({},a,o),r=!0),u.default.newRecord(i,t)});return r&&(this.state=n,this._updateIndexes(e)),i},e.prototype.upsertNormalized=function(e){var t=this,n={ids:[],byId:{},indexes:{}},r={ids:[],byId:{},indexes:{}};e.ids.forEach(function(i){t.exists(i)?(n.ids.push(i),n.byId[i]=e.byId[i]):(r.ids.push(i),r.byId[i]=e.byId[i])});var i=(n.ids.length?this.updateNormalized(n):[]).concat(r.ids.length?this.insertNormalized(r):[]);return this._updateIndexes(e),i},e.prototype._normalizedAction=function(e,t){var r=new n.NormalizeContext(this.schema);this.schema.normalize(e,r);var i=r.output[this.schema.name],o=i?t.call(this,i):[];return this.session.upsert(r),o},e.prototype._updateIndexes=function(e){var t=this;Object.keys(e.indexes).forEach(function(n){var i=t.state.indexes[n]||(t.state.indexes[n]={});Object.keys(e.indexes[n]).forEach(function(t){var o=i[t]||(i[t]=[]);i[t]=r.arrayMerge(o,e.indexes[n][t])})})},e}();t.TableModel=i;var o=function(){function e(e,t){this.id=e,this.table=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.value(this.id)},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.update(e),this},e}();t.RecordModel=o;var a=function(){function e(e,t){this.name=e.name,this.schema=e,this.record=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.schema.getRecordValue(this.record)},enumerable:!0,configurable:!0}),e}();t.RecordField=a;var s=function(){function e(e,t,n){this.table=e,this.schema=t,this.owner=n}return Object.defineProperty(e.prototype,"value",{get:function(){return this.map(function(e){return e.value})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ids",{get:function(){return this.table.index(this.schema.name,this.owner.id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var e=this;return this.ids.map(function(t){return u.default.newRecord(t,e.table)})},e.prototype.map=function(e){return this.all().map(e)},e.prototype.add=function(e){this.table.insert(this._normalize(e))},e.prototype.remove=function(e){var t=this;this._normalize(e).forEach(function(e){var n=t.table.schema.getPrimaryKey(e);t.table.delete(n)})},e.prototype.update=function(e){return this.table.update(this._normalize(e)),this},e.prototype.delete=function(){var e=this;this.all().forEach(function(t){return e.table.delete(t.id)})},e.prototype._normalize=function(e){return this.table.schema.inferRelations(e,this.schema,this.owner.id)},e}();t.RecordSet=s;var u=function(){function e(){this._recordClass={}}return e.prototype.newRecord=function(e,t){return new(this._recordClass[t.schema.name]||(this._recordClass[t.schema.name]=this._createRecordModelClass(t.schema)))(e,t)},e.prototype.newRecordField=function(e,t){if("FK"!==e.type)return new a(e,t);var n=e.references&&t.table.session.tables[e.references];if(!n)throw new Error("The foreign key "+e.name+" references an unregistered table: "+e.table.name);return n.getOrDefault(e.getRecordValue(t))},e.prototype.newRecordSet=function(e,t){var n=t.table.session.tables[e.table.name];return new s(n,e,t)},e.prototype._createRecordModelClass=function(t){var n=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r._fields={},r}return __extends(t,e),t}(o),r=function(e,t,r){Object.defineProperty(n.prototype,e,{get:function(){return this._fields[e]||(this._fields[e]=r(t,this))}})};return t.fields.forEach(function(t){return"PK"!==t.type&&r(t.propName,t,e.default.newRecordField)}),t.relations.forEach(function(t){return t.relationName&&r(t.relationName,t,e.default.newRecordSet)}),n},e.default=new e,e}()}),define("index",["require","exports","schema","models","utils"],function(e,t,n,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Record=r.RecordModel,t.RecordSet=r.RecordSet,t.Table=r.TableModel;var o={};t.createDatabase=function(e,t){return new a(e,__assign({},o,t))};var a=function(){function e(e,t){var r=this;this._cache={},this.options=t,this.normalizeHooks=t.onNormalize||{},this.tables=Object.keys(e).map(function(t){return new n.TableSchema(r,t,e[t])}),this.tables.forEach(function(e){return e.connect(r.tables)})}return e.prototype.combineReducers=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return function(n,r){void 0===n&&(n={});var i=e.createSession(n);return t.forEach(function(e){e(i.tables,r)}),i.commit()}},e.prototype.createSession=function(e,t){return new s(e,this,__assign({readOnly:!1},t))},e.prototype.selectTables=function(e){var t=this,n=Object.keys(e).map(function(e){var n=t.tables.filter(function(t){return t.name===e})[0];if(!n)throw new Error("Cloud not select table. The schema with name: "+e+" is not defined.");return n});return new s(e,{tables:n},{readOnly:!0}).tables},e.prototype.selectTable=function(e,t){var n=t||e.name;if(!n)throw new Error("Failed to select table. Could not identify table schema.");return this.selectTables((r={},r[n]=e,r))[n];var r},e.prototype.cache=function(e,t){return this._cache[e]||t&&(this._cache[e]=t())},e.prototype.clearCache=function(e){delete this._cache[e]},e}();t.Database=a;var s=function(){function e(e,t,n){void 0===e&&(e={});var o=this;this.state=e,this.db=t,this.options=n,this.tables=i.toObject(t.tables.map(function(t){return new r.TableModel(o,e[t.name],t)}),function(e){return e.schema.name})}return e.prototype.upsert=function(e){var t=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");Object.keys(e.output).forEach(function(n){n!==e.schema.name&&t.tables[n].upsertNormalized(e.output[n])}),Object.keys(e.emits).forEach(function(n){n!==e.schema.name&&t.tables[n].upsert(e.emits[n])})},e.prototype.commit=function(){var e=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");return Object.keys(this.tables).forEach(function(t){var n=e.state[t],r=e.tables[t].state;n!==r&&(e.state=__assign({},e.state,(i={},i[t]=r,i)));var i}),this.state},e}();t.DatabaseSession=s});
=======
var __assign=this&&this.__assign||Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();define("utils",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(e){return e?Array.isArray(e)?e:"object"==typeof e?Object.keys(e).map(function(t){return e[t]}):[]:[]},t.ensureArray=function(e){return e?Array.isArray(e)?e:[e]:[]},t.toObject=function(e,t){return e.reduce(function(e,n){return e[t(n)]=n,e},{})},t.arrayMerge=function(e,t){var n,r={};for(n=0;n<e.length;n++)r[e[n]]=!0;for(n=0;n<t.length;n++)r[t[n]]=!0;return Object.keys(r)},t.isEqual=function(e,t){if(e===t)return!0;var r=Object.keys(e),i=Object.keys(t),a=r.length;if(i.length!==a)return!1;for(var o=0;o<a;o++){var s=r[o];if(!(Array.isArray(e[s])&&Array.isArray(t[s])&&n(e[s],t[s]))&&e[s]!==t[s])return!1}return!0};var n=function(e,t){if(e===t)return!0;var n=e.length;if(t.length!==n)return!1;for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}}),define("schema",["require","exports","utils"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="PK",i="FK",a=function(){function e(e){this.output={},this.emits={},this.schema=e,this.db=e.db}return e.prototype.emit=function(e,t){this.emits[e]=this.emits[e]||[],this.emits[e].push(t)},e}();t.NormalizeContext=a;var o=function(){function e(e,t,n){var a=this;this.relations=[],this.db=e,this.name=t,this.fields=Object.keys(n).map(function(e){return new s(a,e,n[e])}),this._primaryKeyFields=this.fields.filter(function(e){return e.type===r}),this._foreignKeyFields=this.fields.filter(function(e){return e.type===i}),this._stampFields=this.fields.filter(function(e){return"MODIFIED"===e.type})}return e.prototype.connect=function(e){var t=this;e.forEach(function(e){t.relations=t.relations.concat(e.fields.filter(function(e){return e.references===t.name}))}),this._foreignKeyFields.forEach(function(t){t.references&&(t.refTable=e.filter(function(e){return e.name===t.references})[0])})},e.prototype.normalize=function(e,t){var r=this;if("object"!=typeof e&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");var i=t||new a(this);return i.output[this.name]||(i.output[this.name]={ids:[],byId:{},indexes:{}}),n.ensureArray(e).map(function(e){var t=r.db.normalizeHooks?r.db.normalizeHooks[r.name]:null;t&&(e=t(e,i));var n=r.getPrimaryKey(e),a=r.getForeignKeys(e),o=i.output[r.name],s=o.byId[n]=__assign({},e);o.ids.push(n),a.forEach(function(e){if("object"==typeof e.value&&e.refTable){var t=e.refTable.normalize(e.value,i);if(t.length>1)throw new Error('Invalid schema definition. The field "'+r.name+"."+e.name+'" is referencing table "'+e.refTable.name+'", but the given data is an array.');s[e.name]=e.value=t[0]}null!==e.value&&void 0!==e.value&&(o.indexes[e.name]||(o.indexes[e.name]={}),o.indexes[e.name][e.value]||(o.indexes[e.name][e.value]=[]),o.indexes[e.name][e.value].push(n))});return r.relations.forEach(function(e){if(e.relationName&&s[e.relationName]){var t=r.inferRelations(s[e.relationName],e,n);e.table.normalize(t,i),delete s[e.relationName]}}),n})},e.prototype.inferRelations=function(e,t,r){if(!t.relationName)return e;var a=t.table.fields.filter(function(e){return e.type===i&&e!==t});return n.ensureArray(e).map(function(e){return"number"!=typeof e&&"string"!=typeof e||(1===a.length?((n={})[a[0].name]=e,e=n):e={id:e}),__assign({},e,(i={},i[t.name]=r,i));var n,i})},e.prototype.getPrimaryKey=function(e){var t=(this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields).reduce(function(t,n){var r=n.getValue(e);return t&&r?t+"_"+r:r},null);if(null!==t&&void 0!==t&&"string"!=typeof t&&(t=t.toString()),!t||0===t.length)throw new Error('Failed to get primary key for record of type "'+this.name+'".');return t},e.prototype.getForeignKeys=function(e){return this._foreignKeyFields.map(function(t){return{name:t.name,value:e[t.name],refTable:t.refTable}})},e.prototype.isModified=function(e,t){return this._stampFields.length>0?this._stampFields.reduce(function(n,r){return n+(r.getValue(e)===r.getValue(t)?1:0)},0)!==this._stampFields.length:!n.isEqual(e,t)},e}();t.TableSchema=o;var s=function(){function e(e,t,n){this.table=e,this.name=t,this.propName=n.propName||t,this.type=n.type||n.constraint||(n.references?"FK":"ATTR"),this.references=n.references,this.relationName=n.relationName,this._valueFn=n.value?n.value.bind(this):null}return e.prototype.getValue=function(e,t){return this._valueFn?this._valueFn(e,{schema:this,record:t}):e[this.name]},e.prototype.getRecordValue=function(e){return this.getValue(e.value,e)},e}();t.FieldSchema=s}),define("models",["require","exports","schema","utils"],function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n){void 0===t&&(t={ids:[],byId:{},indexes:{}}),this.session=e,this.state=t,this.schema=n,this.state.name||(this.state.name=n.name)}return e.prototype.all=function(){var e=this;return this.state.ids.map(function(t){return u.default.newRecord(t,e)})},Object.defineProperty(e.prototype,"length",{get:function(){return this.state.ids.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"values",{get:function(){return this.all().map(function(e){return e.value})},enumerable:!0,configurable:!0}),e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.index=function(e,t){return this.state.indexes[e]&&this.state.indexes[e][t]?this.state.indexes[e][t]:[]},e.prototype.get=function(e){if(e=e.toString(),!this.exists(e))throw new Error('No "'+this.schema.name+'" record with id: '+e+" exists.");return u.default.newRecord(e,this)},e.prototype.value=function(e){return"number"==typeof e&&(e=e.toString()),this.state.byId[e]},e.prototype.getOrDefault=function(e){return this.exists(e)?this.get(e):null},e.prototype.exists=function(e){return void 0!==this.state.byId[e]},e.prototype.insert=function(e){return this.insertMany(e)[0]},e.prototype.insertMany=function(e){return this._normalizedAction(e,this.insertNormalized)},e.prototype.update=function(e){return this.updateMany(e)[0]},e.prototype.updateMany=function(e){return this._normalizedAction(e,this.updateNormalized)},e.prototype.upsert=function(e){return this._normalizedAction(e,this.upsertNormalized)[0]},e.prototype.delete=function(e){var t=__assign({},this.state.byId),n=this.state.ids.slice(),r=__assign({},this.state.indexes),i=t[e];delete t[e];var a=n.indexOf(e);a>=0&&n.splice(a,1),i&&this.schema.getForeignKeys(i).forEach(function(t){var n=t.value&&r[t.name]&&r[t.name][t.value]&&r[t.name][t.value].indexOf(e);if(n>=0){var i=r[t.name][t.value].slice();i.splice(n,1),r[t.name][t.value]=i}else r[t.name]&&(delete r[t.name][e],0===Object.keys(r[t.name]).length&&delete r[t.name])}),this.state=__assign({},this.state,{byId:t,ids:n,indexes:r})},e.prototype.insertNormalized=function(e){var t=this;return this.state=__assign({},this.state,{ids:r.arrayMerge(this.state.ids,e.ids),byId:__assign({},this.state.byId,e.byId)}),this._updateIndexes(e),e.ids.map(function(e){return u.default.newRecord(e,t)})},e.prototype.updateNormalized=function(e){var t=this,n=__assign({},this.state),r=!1,i=Object.keys(e.byId).map(function(i){if(!t.state.byId[i])throw new Error('Failed to apply update. No "'+t.schema.name+'" record with id: '+i+" exists.");var a=n.byId[i],o=__assign({},a,e.byId[i]);return t.schema.isModified(a,o)&&(n.byId[i]=o,r=!0),u.default.newRecord(i,t)});return r&&(this.state=n,this._updateIndexes(e)),i},e.prototype.upsertNormalized=function(e){var t=this,n={ids:[],byId:{},indexes:{}},r={ids:[],byId:{},indexes:{}};e.ids.forEach(function(i){t.exists(i)?(n.ids.push(i),n.byId[i]=e.byId[i]):(r.ids.push(i),r.byId[i]=e.byId[i])});var i=(n.ids.length?this.updateNormalized(n):[]).concat(r.ids.length?this.insertNormalized(r):[]);return this._updateIndexes(e),i},e.prototype._normalizedAction=function(e,t){var r=new n.NormalizeContext(this.schema);this.schema.normalize(e,r);var i=r.output[this.schema.name],a=i?t.call(this,i):[];return this.session.upsert(r),a},e.prototype._updateIndexes=function(e){var t=this;Object.keys(e.indexes).forEach(function(n){var i=t.state.indexes[n]||(t.state.indexes[n]={});Object.keys(e.indexes[n]).forEach(function(t){var a=i[t]||(i[t]=[]);i[t]=r.arrayMerge(a,e.indexes[n][t])})})},e}();t.TableModel=i;var a=function(){function e(e,t){this.id=e,this.table=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.value(this.id)},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.update(e),this},e}();t.RecordModel=a;var o=function(){function e(e,t){this.name=e.name,this.schema=e,this.record=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.schema.getRecordValue(this.record)},enumerable:!0,configurable:!0}),e}();t.RecordField=o;var s=function(){function e(e,t,n){this.table=e,this.schema=t,this.owner=n}return Object.defineProperty(e.prototype,"value",{get:function(){return this.map(function(e){return e.value})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ids",{get:function(){return this.table.index(this.schema.name,this.owner.id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var e=this;return this.ids.map(function(t){return u.default.newRecord(t,e.table)})},e.prototype.map=function(e){return this.all().map(e)},e.prototype.add=function(e){this.table.insert(this._normalize(e))},e.prototype.remove=function(e){var t=this;this._normalize(e).forEach(function(e){var n=t.table.schema.getPrimaryKey(e);t.table.delete(n)})},e.prototype.update=function(e){return this.table.update(this._normalize(e)),this},e.prototype.delete=function(){var e=this;this.all().forEach(function(t){return e.table.delete(t.id)})},e.prototype._normalize=function(e){return this.table.schema.inferRelations(e,this.schema,this.owner.id)},e}();t.RecordSet=s;var u=function(){function e(){this._recordClass={}}return e.prototype.newRecord=function(e,t){return new(this._recordClass[t.schema.name]||(this._recordClass[t.schema.name]=this._createRecordModelClass(t.schema)))(e,t)},e.prototype.newRecordField=function(e,t){if("FK"!==e.type)return new o(e,t);var n=e.references&&t.table.session.tables[e.references];if(!n)throw new Error("The foreign key "+e.name+" references an unregistered table: "+e.table.name);return n.getOrDefault(e.getRecordValue(t))},e.prototype.newRecordSet=function(e,t){var n=t.table.session.tables[e.table.name];return new s(n,e,t)},e.prototype._createRecordModelClass=function(t){var n=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r._fields={},r}return __extends(t,e),t}(a),r=function(e,t,r){Object.defineProperty(n.prototype,e,{get:function(){return this._fields[e]||(this._fields[e]=r(t,this))}})};return t.fields.forEach(function(t){return"PK"!==t.type&&r(t.propName,t,e.default.newRecordField)}),t.relations.forEach(function(t){return t.relationName&&r(t.relationName,t,e.default.newRecordSet)}),n},e.default=new e,e}()}),define("index",["require","exports","schema","models","utils"],function(e,t,n,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Record=r.RecordModel,t.RecordSet=r.RecordSet,t.Table=r.TableModel;var a={};t.createDatabase=function(e,t){return new o(e,__assign({},a,t))};var o=function(){function e(e,t){var r=this;this._cache={},this.options=t,this.normalizeHooks=t.onNormalize||{},this.tables=Object.keys(e).map(function(t){return new n.TableSchema(r,t,e[t])}),this.tables.forEach(function(e){return e.connect(r.tables)})}return e.prototype.combineReducers=function(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return function(n,r){void 0===n&&(n={});var i=e.createSession(n);return t.forEach(function(e){e(i.tables,r)}),i.commit()}},e.prototype.createSession=function(e,t){return new s(e,this,__assign({readOnly:!1},t))},e.prototype.selectTables=function(e){var t=this,n=Object.keys(e).map(function(e){var n=t.tables.filter(function(t){return t.name===e})[0];if(!n)throw new Error("Cloud not select table. The schema with name: "+e+" is not defined.");return n});return new s(e,{tables:n},{readOnly:!0}).tables},e.prototype.selectTable=function(e,t){var n=t||e.name;if(!n)throw new Error("Failed to select table. Could not identify table schema.");return this.selectTables((r={},r[n]=e,r))[n];var r},e.prototype.cache=function(e,t){return this._cache[e]||t&&(this._cache[e]=t())},e.prototype.clearCache=function(e){delete this._cache[e]},e}();t.Database=o;var s=function(){function e(e,t,n){void 0===e&&(e={});var a=this;this.state=e,this.db=t,this.options=n,this.tables=i.toObject(t.tables.map(function(t){return new r.TableModel(a,e[t.name],t)}),function(e){return e.schema.name})}return e.prototype.upsert=function(e){var t=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");Object.keys(e.output).forEach(function(n){n!==e.schema.name&&t.tables[n].upsertNormalized(e.output[n])}),Object.keys(e.emits).forEach(function(n){n!==e.schema.name&&t.tables[n].upsert(e.emits[n])})},e.prototype.commit=function(){var e=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");return Object.keys(this.tables).forEach(function(t){var n=e.state[t],r=e.tables[t].state;n!==r&&(e.state=__assign({},e.state,(i={},i[t]=r,i)));var i}),this.state},e}();t.DatabaseSession=s});
>>>>>>> 3b93bf0045ea6117b3f37e5f87bfa870d7be5fb1
