var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__assign=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e};define("utils",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(e){return e?Array.isArray(e)?e:"object"==typeof e?Object.keys(e).map(function(t){return e[t]}):[]:[]},t.ensureArray=function(e){return e?Array.isArray(e)?e:[e]:[]},t.toObject=function(e,t){return e.reduce(function(e,r){return e[t(r)]=r,e},{})},t.isObject=function(e){return null!=e&&"object"==typeof e&&!1===Array.isArray(e)};var r=function(e){return t.isObject(e)&&"[object Object]"===Object.prototype.toString.call(e)};t.isPlainObject=function(e){var t,n;return r(e)&&"function"!=typeof(t=e.constructor)&&r(n=t.prototype)&&n.hasOwnProperty("isPrototypeOf")}}),define("schema",["require","exports","utils"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="PK",i="FK",o=function(){function e(e,t){var r=this;this.relations=[],this.name=e,this.fields=Object.keys(t).map(function(e){return new s(r,e,t[e])}),this._primaryKeyFields=this.fields.filter(function(e){return e.constraint===n}).map(function(e){return e.name}),this._foreignKeyFields=this.fields.filter(function(e){return e.constraint===i}).map(function(e){return e.name}),this._stampFields=this.fields.filter(function(e){return"MODIFIED"===e.type}).map(function(e){return e.name})}return e.prototype.connect=function(e){var t=this;e.forEach(function(e){t.relations=t.relations.concat(e.fields.filter(function(e){return e.references===t.name}))})},e.prototype.normalize=function(e,t){var n=this;if(void 0===t&&(t={}),"object"!=typeof e&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");if(t[this.name])throw new Error("Failed to normalize data. Circular reference detected.");return t[this.name]={ids:[],byId:{}},t[this.name].ids=r.ensureArray(e).map(function(r){var i=n.getPrimaryKey(e);t[n.name].byId[i]=r;return n.relations.forEach(function(r){r.relationName&&e[r.relationName]&&(r.table.normalize(e[r.relationName],t),delete e[r.relationName])}),i}),t},e.prototype.getPrimaryKey=function(e){var t=this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields,r=null;if(1===t.length?r=e[t[0]]:t.length>1&&(r=t.reduce(function(t,r){var n=e[r];return t&&n?t+"_"+n:n},null)),null!==r&&void 0!==r&&"string"!=typeof r&&(r=r.toString()),!r||0===r.length)throw new Error('Failed to get primary key for record of type "'+this.name+'".');return r},e.prototype.isModified=function(e,t){var r=this;return 1===this._stampFields.length?e[this._stampFields[0]]===t[this._stampFields[0]]:!(this._stampFields.length>1)||this._stampFields.reduce(function(n,i){return n+(e[r._stampFields[0]]===t[r._stampFields[0]]?1:0)},0)!==this._stampFields.length},e}();t.TableSchema=o;var s=function(){function e(e,t,r){this.table=e,this.name=t,this.propName=r.name||t,this.type=r.type||"ATTR",this.constraint=r.constraint||"NONE",this.references=r.references,this.relationName=r.relationName}return e}();t.FieldSchema=s}),define("models",["require","exports","utils"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){void 0===e&&(e={});var n=this;this.state=e,this.tables=r.toObject(t.tables.map(function(t){return new i(n,e[t.name],t)}),function(e){return e.schema.name})}return e.prototype.upsert=function(e,t){var r=this;Object.keys(e).forEach(function(n){t&&n===t.schema.name||r.tables[n].upsert(e[n])})},e.prototype.commit=function(){var e=this;return Object.keys(this.tables).forEach(function(t){var r=e.state[t],n=e.tables[t].state;r!==n&&(e.state=__assign({},e.state,(i={},i[t]=n,i)));var i}),this.state},e}();t.Session=n;var i=function(){function e(e,t,r){void 0===t&&(t={ids:[],byId:{}}),this.session=e,this.state=t,this.schema=r}return e.prototype.all=function(){var e=this;return this.state.ids.map(function(t){return c.default.newRecordModel(t,e)})},e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.get=function(e){if(e=e.toString(),!this.exists(e))throw new Error('No "'+this.schema.name+'" record with id: '+e+" exists.");return c.default.newRecordModel(e,this)},e.prototype.getOrDefault=function(e){return this.exists(e)?this.get(e):null},e.prototype.exists=function(e){return void 0!==this.state.byId[e]},e.prototype.insert=function(e){return this.insertMany(e)[0]},e.prototype.insertMany=function(e){var t=this,r=this.schema.normalize(e),n=r[this.schema.name];return this.state={ids:this.state.ids.concat(n.ids),byId:__assign({},this.state.byId,n.byId)},this.session.upsert(r,this),n.ids.map(function(e){return c.default.newRecordModel(e,t)})},e.prototype.update=function(e){return this.updateMany(e)[0]},e.prototype.updateMany=function(e){var t=this,r=this.schema.normalize(e),n=r[this.schema.name],i=__assign({},this.state),o=Object.keys(n.byId).map(function(e){if(!t.state.byId[e])throw new Error('Failed to apply update. No "'+t.schema.name+'" record with id: '+e+" exists.");var r=n.byId[e],o=i.byId[e];return t.schema.isModified(o,r)&&(i.byId[e]=__assign({},o,r)),c.default.newRecordModel(e,t)});return this.state=i,this.session.upsert(r,this),o},e.prototype.upsert=function(e){var t=this.schema.getPrimaryKey(e);return this.exists(t)?this.update(e):this.insert(e)},e.prototype.delete=function(e){var t=__assign({},this.state.byId),r=this.state.ids.slice();delete t[e];var n=r.indexOf(e);n>=0&&r.splice(n,1),this.state=__assign({},this.state,{byId:t,ids:r})},e}();t.TableModel=i;var o=function(){function e(e,t){this.id=e,this.table=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.state.byId[this.id]},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.update(e),this},e}();t.RecordModel=o;var s=function(){function e(e,t){this.name=e.name,this.schema=e,this.record=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.record.value[this.name]},enumerable:!0,configurable:!0}),e}();t.RecordField=s;var a=function(){function e(e,t,r){this.records=e,this.table=t,this.referencedFrom=r}return e.prototype.map=function(e){return this.records.map(e)},e.prototype.insert=function(e){},e.prototype.update=function(e){},e}();t.RecordSet=a;var c=function(){function e(){this._recordClass={}}return e.prototype.newRecordModel=function(e,t){return new(this._recordClass[t.schema.name]||(this._recordClass[t.schema.name]=this._createRecordModelClass(t.schema)))(e,t)},e.prototype.newRecordField=function(e,t){if("FK"===e.constraint&&e.table===t.table.schema&&e.references){if(!(n=t.table.session.tables[e.references]))throw new Error("The foreign key "+e.name+" references an unregistered table: "+e.table.name);var r=t.value[e.name];return n.getOrDefault(r)}if("FK"===e.constraint&&e.table!==t.table.schema&&e.relationName){var n=t.table.session.tables[e.table.name];if(!n)throw new Error("The foreign key "+e.name+" references an unregistered table: "+e.table.name);var i=n.filter(function(r){var n=r.value[e.name];return n&&n.toString()===t.id});return new a(i,n,new s(e,t))}return new s(e,t)},e.prototype._createRecordModelClass=function(t){var r=function(e){function t(t,r){return e.call(this,t,r)||this}return __extends(t,e),t}(o);return t.fields.forEach(function(t){"FK"==t.constraint&&Object.defineProperty(r.prototype,t.propName,{get:function(){return e.default.newRecordField(t,this)},set:function(e){return this.update((r={},r[t.name]=e,r));var r}})}),t.relations.forEach(function(t){t.relationName&&Object.defineProperty(r.prototype,t.relationName,{get:function(){return e.default.newRecordField(t,this)},set:function(e){throw new Error("Invalid attempt to set an foreign table relation field.")}})}),r},e}();c.default=new c}),define("index",["require","exports","schema","models"],function(e,t,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Record=n.RecordModel,t.RecordSet=n.RecordSet,t.Table=n.TableModel,t.createDatabase=function(e,t){var n=Object.keys(t).map(function(e){return new r.TableSchema(e,t[e])});return n.forEach(function(e){return e.connect(n)}),new o(e,n)};var i=function(e,t){return function(r,n){void 0===r&&(r={});var i=e.createSession(r);return t.forEach(function(e){e(i.tables,n)}),i.commit()}};t.combineReducers=i;var o=function(){function e(e,t){this.name=e,this.tables=t}return e.prototype.combineReducers=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i(this,e)},e.prototype.createSession=function(e){return new n.Session(e,this)},e}();t.Database=o});